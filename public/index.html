<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Song Requests</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Lucide Icons as inline SVG components
    const Music = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
      </svg>
    );

    const Search = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    );

    const CheckCircle = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const Clock = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const PlayCircle = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const ChevronDown = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
      </svg>
    );

    const ChevronUp = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
      </svg>
    );

    const Users = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
    );

    const List = ({ className = "w-6 h-6" }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    );

    // Backend API configuration
    const API_URL = window.location.origin + '/api';

    function DJRequestInterface() {
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [showDropdown, setShowDropdown] = useState(false);
      const [isSearching, setIsSearching] = useState(false);
      const [showWelcome, setShowWelcome] = useState(true);
      const [requestSuccess, setRequestSuccess] = useState(false);
      const [recentRequests, setRecentRequests] = useState([]);
      const [cooldownSeconds, setCooldownSeconds] = useState(0);
      const [queuedSongs, setQueuedSongs] = useState([]);
      const [recentlyPlayedSongs, setRecentlyPlayedSongs] = useState([]);
      const [errorMessage, setErrorMessage] = useState('');
      const [nowPlaying, setNowPlaying] = useState(null);
      const [playbackStatus, setPlaybackStatus] = useState({
        duration: 0,
        position: 0,
        time_remaining: 0,
        playing: false
      });
      const [userRequestCount, setUserRequestCount] = useState(0);
      const [showFullQueue, setShowFullQueue] = useState(false);
      const [settings, setSettings] = useState({
        theme: 'general',
        explicitAllowed: true,
        colors: {
          primary: '#8b5cf6',
          secondary: '#3b82f6',
          background: '#1e1b4e'
        },
        eventName: '',
        customMessage: ''
      });
      const searchRef = useRef(null);

      const MAX_USER_REQUESTS = 5;

      // Real YouTube Music search via backend
      const searchYouTubeMusic = async (query) => {
        try {
          const response = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}`);
          if (!response.ok) throw new Error('Search failed');
          const data = await response.json();
          return data.songs || [];
        } catch (error) {
          console.error('Search error:', error);
          setErrorMessage('Failed to search. Please try again.');
          return [];
        }
      };

      // Handle search with debounce
      useEffect(() => {
        if (searchQuery.length < 2) {
          setSearchResults([]);
          setShowDropdown(false);
          return;
        }

        const timeoutId = setTimeout(async () => {
          setIsSearching(true);
          setErrorMessage('');
          const results = await searchYouTubeMusic(searchQuery);
          setSearchResults(results);
          setShowDropdown(true);
          setIsSearching(false);
        }, 400);

        return () => clearTimeout(timeoutId);
      }, [searchQuery]);

      // Cooldown timer
      useEffect(() => {
        if (cooldownSeconds > 0) {
          const timerId = setInterval(() => {
            setCooldownSeconds(prev => prev - 1);
          }, 1000);
          return () => clearInterval(timerId);
        }
      }, [cooldownSeconds]);

      // Load queue, playback status, and user request count
      useEffect(() => {
        const loadData = async () => {
          try {
            // Load settings
            const settingsRes = await fetch(`${API_URL}/settings`);
            if (settingsRes.ok) {
              const settingsData = await settingsRes.json();
              if (settingsData.settings) {
                setSettings(settingsData.settings);
              }
            }

            // Load queue
            const queueRes = await fetch(`${API_URL}/queue`);
            if (queueRes.ok) {
              const queueData = await queueRes.json();
              setQueuedSongs(queueData.queue || []);
              if (queueData.queue && queueData.queue.length > 0) {
                setNowPlaying(queueData.queue[0]);
              } else {
                setNowPlaying(null);
              }
            }

            // Load recently played
            const recentRes = await fetch(`${API_URL}/recently-played`);
            if (recentRes.ok) {
              const recentData = await recentRes.json();
              setRecentlyPlayedSongs(recentData.recentlyPlayed || []);
            }

            // Load user's request count
            const userRes = await fetch(`${API_URL}/user-request-count`);
            if (userRes.ok) {
              const userData = await userRes.json();
              setUserRequestCount(userData.count || 0);
            }
          } catch (error) {
            console.error('Failed to load data:', error);
          }
        };

        loadData();
        const interval = setInterval(loadData, 3000);
        return () => clearInterval(interval);
      }, []);

      // Close dropdown when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (searchRef.current && !searchRef.current.contains(e.target)) {
            setShowDropdown(false);
          }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      const handleSongSelect = async (song) => {
        if (cooldownSeconds > 0) {
          return;
        }

        if (userRequestCount >= MAX_USER_REQUESTS) {
          setErrorMessage(`You can only have ${MAX_USER_REQUESTS} songs in the queue at once!`);
          setTimeout(() => setErrorMessage(''), 3000);
          return;
        }

        const isInQueue = queuedSongs.some(s => s.song_id === song.id);
        if (isInQueue) {
          setErrorMessage('This song is already in the queue!');
          setTimeout(() => setErrorMessage(''), 3000);
          return;
        }

        const isRecentlyPlayed = recentlyPlayedSongs.some(s => s.song_id === song.id);
        if (isRecentlyPlayed) {
          setErrorMessage('This song was played recently. Please choose another!');
          setTimeout(() => setErrorMessage(''), 3000);
          return;
        }

        try {
          const response = await fetch(`${API_URL}/request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ song })
          });

          const data = await response.json();

          if (!response.ok) {
            setErrorMessage(data.error || 'Failed to add song');
            setTimeout(() => setErrorMessage(''), 3000);
            return;
          }

          const newRequest = {
            ...song,
            requestedAt: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          };
          setRecentRequests(prev => [newRequest, ...prev.slice(0, 4)]);
          
          setQueuedSongs(prev => [...prev, { song_id: song.id, ...song }]);
          setUserRequestCount(prev => prev + 1);
          
          setRequestSuccess(true);
          setSearchQuery('');
          setShowDropdown(false);
          
          setCooldownSeconds(30);
          
          setTimeout(() => setRequestSuccess(false), 3000);

        } catch (error) {
          console.error('Request error:', error);
          setErrorMessage('Failed to add song. Please try again.');
          setTimeout(() => setErrorMessage(''), 3000);
        }
      };

      const isSongUnavailable = (song) => {
        const isInQueue = queuedSongs.some(s => s.song_id === song.id);
        const isRecentlyPlayed = recentlyPlayedSongs.some(s => s.song_id === song.id);
        return isInQueue || isRecentlyPlayed;
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const formatDuration = (durationStr) => {
        if (typeof durationStr === 'string' && durationStr.includes(':')) {
          return durationStr;
        }
        return formatTime(parseInt(durationStr) || 0);
      };

      if (showWelcome) {
        const bgGradient = `linear-gradient(to bottom right, ${settings.colors.background}, ${settings.colors.primary}40, black)`;
        const buttonGradient = `linear-gradient(to right, ${settings.colors.primary}, ${settings.colors.secondary})`;
        const accentGradient = `linear-gradient(to right, ${settings.colors.primary}cc, ${settings.colors.secondary}cc)`;
        
        return (
          <div className="min-h-screen flex items-center justify-center p-4" style={{ background: bgGradient }}>
            <div className="max-w-md w-full bg-black bg-opacity-50 backdrop-blur-lg rounded-2xl p-8 shadow-2xl border border-opacity-30" style={{ borderColor: settings.colors.primary }}>
              <div className="flex justify-center mb-6">
                <div className="p-4 rounded-full" style={{ background: buttonGradient }}>
                  <Music className="w-12 h-12 text-white" />
                </div>
              </div>
              
              <h1 className="text-3xl font-bold text-white text-center mb-2">
                {settings.eventName || 'Welcome to DJ Requests'}
              </h1>
              
              {settings.customMessage && (
                <p className="text-purple-200 text-center mb-4 text-sm">
                  {settings.customMessage}
                </p>
              )}
              
              <div className="rounded-lg p-6 mb-6" style={{ background: accentGradient }}>
                <h2 className="text-white font-semibold mb-3 text-lg">How to Request:</h2>
                <ol className="text-white space-y-2 text-sm">
                  <li className="flex items-start">
                    <span className="font-bold mr-2">1.</span>
                    <span>Type the song name you want to hear</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-bold mr-2">2.</span>
                    <span>Select your song from the dropdown</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-bold mr-2">3.</span>
                    <span>Click "Request" and enjoy!</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-bold mr-2">4.</span>
                    <span>Max {MAX_USER_REQUESTS} songs per person in queue</span>
                  </li>
                </ol>
              </div>
              
              <button
                onClick={() => setShowWelcome(false)}
                className="w-full text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 shadow-lg"
                style={{ background: buttonGradient }}
              >
                Start Requesting Songs
              </button>
            </div>
          </div>
        );
      }

      const upcomingSongs = queuedSongs.slice(1, showFullQueue ? undefined : 6);
      const hasMoreSongs = queuedSongs.length > 6;
      
      const bgGradient = `linear-gradient(to bottom right, ${settings.colors.background}, ${settings.colors.primary}40, black)`;
      const headerGradient = `linear-gradient(to right, ${settings.colors.primary}, ${settings.colors.secondary})`;

      return (
        <div className="min-h-screen p-4" style={{ background: bgGradient }}>
          <div className="max-w-2xl mx-auto pt-8">
            <div className="text-center mb-8">
              <div className="flex justify-center mb-4">
                <div className="p-3 rounded-full" style={{ background: headerGradient }}>
                  <Music className="w-8 h-8 text-white" />
                </div>
              </div>
              <h1 className="text-3xl font-bold text-white mb-2">
                {settings.eventName || 'Request Your Song'}
              </h1>
              <p className="text-purple-300">Search and add songs to the DJ queue</p>
            </div>

            {nowPlaying && (
              <div className="mb-6 rounded-2xl p-5 shadow-2xl" style={{ background: headerGradient }}>
                <div className="flex items-center gap-2 mb-3">
                  <PlayCircle className="w-5 h-5 text-white" />
                  <span className="text-white font-semibold text-sm">NOW PLAYING</span>
                </div>
                
                <div className="bg-black bg-opacity-30 rounded-lg p-4">
                  <div className="text-xl font-bold text-white mb-1 truncate">{nowPlaying.title}</div>
                  <div className="text-purple-200 truncate">{nowPlaying.artist}</div>
                </div>
              </div>
            )}

            {queuedSongs.length > 1 && (
              <div className="mb-6 bg-black bg-opacity-50 backdrop-blur-lg rounded-2xl p-5 shadow-2xl border border-opacity-30" style={{ borderColor: settings.colors.primary }}>
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <List className="w-5 h-5 text-purple-400" />
                    <h2 className="text-lg font-bold text-white">
                      Coming Up Next ({queuedSongs.length - 1} {queuedSongs.length === 2 ? 'song' : 'songs'})
                    </h2>
                  </div>
                </div>

                <div className="space-y-2">
                  {upcomingSongs.map((song, index) => (
                    <div key={song.id} className="bg-gray-900 bg-opacity-50 rounded-lg p-3 border border-gray-700">
                      <div className="flex items-center gap-3">
                        <div className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center" style={{ background: settings.colors.primary }}>
                          <span className="text-white font-bold text-xs">{index + 1}</span>
                        </div>
                        
                        <div className="flex-1 min-w-0">
                          <div className="text-white font-medium text-sm truncate">{song.title}</div>
                          <div className="text-gray-400 text-xs truncate">{song.artist}</div>
                        </div>
                        
                        <span className="text-purple-400 text-xs font-medium whitespace-nowrap">
                          {formatDuration(song.duration)}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>

                {hasMoreSongs && (
                  <button
                    onClick={() => setShowFullQueue(!showFullQueue)}
                    className="w-full mt-3 bg-opacity-30 hover:bg-opacity-40 text-purple-200 font-medium py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2"
                    style={{ backgroundColor: settings.colors.primary }}
                  >
                    {showFullQueue ? (
                      <>
                        <ChevronUp className="w-4 h-4" />
                        Show Less
                      </>
                    ) : (
                      <>
                        <ChevronDown className="w-4 h-4" />
                        Show All {queuedSongs.length - 1} Songs
                      </>
                    )}
                  </button>
                )}
              </div>
            )}

            <div className="mb-6 bg-black bg-opacity-50 backdrop-blur-lg rounded-lg p-4 border border-opacity-30 flex items-center justify-between" style={{ borderColor: settings.colors.primary }}>
              <div className="flex items-center gap-2">
                <Users className="w-5 h-5 text-purple-400" />
                <span className="text-purple-200 font-medium">Your Requests in Queue</span>
              </div>
              <div className="text-white font-bold text-lg">
                {userRequestCount} / {MAX_USER_REQUESTS}
              </div>
            </div>

            {requestSuccess && (
              <div className="mb-6 bg-green-500 bg-opacity-20 border border-green-500 rounded-lg p-4 flex items-center gap-3">
                <CheckCircle className="w-6 h-6 text-green-400" />
                <span className="text-green-200 font-medium">Song added to queue!</span>
              </div>
            )}

            {errorMessage && (
              <div className="mb-6 bg-red-500 bg-opacity-20 border border-red-500 rounded-lg p-4 flex items-center gap-3">
                <span className="text-red-200 font-medium">{errorMessage}</span>
              </div>
            )}

            {cooldownSeconds > 0 && (
              <div className="mb-6 bg-yellow-500 bg-opacity-20 border border-yellow-500 rounded-lg p-4 flex items-center gap-3">
                <Clock className="w-6 h-6 text-yellow-400" />
                <span className="text-yellow-200 font-medium">
                  Please wait {cooldownSeconds} seconds before requesting another song
                </span>
              </div>
            )}

            <div className="bg-black bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-opacity-30 mb-6" style={{ borderColor: settings.colors.primary }}>
              <div className="relative" ref={searchRef}>
                <div className="relative">
                  <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-purple-400 w-5 h-5" />
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    onFocus={() => searchResults.length > 0 && setShowDropdown(true)}
                    placeholder="Search for a song..."
                    disabled={userRequestCount >= MAX_USER_REQUESTS}
                    className="w-full bg-gray-900 bg-opacity-50 text-white pl-12 pr-4 py-4 rounded-lg border border-purple-500 border-opacity-30 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  />
                  {isSearching && (
                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2">
                      <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-500"></div>
                    </div>
                  )}
                </div>

                {userRequestCount >= MAX_USER_REQUESTS && (
                  <p className="text-yellow-300 text-sm mt-2">
                    You've reached the maximum of {MAX_USER_REQUESTS} songs in the queue. Wait for some to play!
                  </p>
                )}

                {showDropdown && searchResults.length > 0 && (
                  <div className="absolute w-full mt-2 bg-gray-900 rounded-lg border border-purple-500 border-opacity-30 shadow-2xl max-h-96 overflow-y-auto z-50">
                    {searchResults.map((song) => {
                      const unavailable = isSongUnavailable(song);
                      const onCooldown = cooldownSeconds > 0;
                      const atLimit = userRequestCount >= MAX_USER_REQUESTS;
                      const disabled = unavailable || onCooldown || atLimit;
                      
                      return (
                        <button
                          key={song.id}
                          onClick={() => !disabled && handleSongSelect(song)}
                          disabled={disabled}
                          className={`w-full text-left p-4 transition-colors border-b border-gray-800 last:border-b-0 group ${
                            disabled 
                              ? 'opacity-50 cursor-not-allowed bg-gray-800' 
                              : 'hover:bg-purple-900 hover:bg-opacity-30'
                          }`}
                        >
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <div className={`font-medium mb-1 truncate transition-colors ${
                                disabled ? 'text-gray-500' : 'text-white group-hover:text-purple-300'
                              }`}>
                                {song.title}
                              </div>
                              <div className="text-gray-400 text-sm truncate">{song.artist}</div>
                              {unavailable && (
                                <div className="text-red-400 text-xs mt-1">
                                  {queuedSongs.some(s => s.song_id === song.id)
                                    ? 'Already in queue' 
                                    : 'Played recently'}
                                </div>
                              )}
                            </div>
                            <div className={`text-sm whitespace-nowrap ${
                              disabled ? 'text-gray-500' : 'text-purple-400'
                            }`}>
                              {song.duration}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>

            {recentRequests.length > 0 && (
              <div className="bg-black bg-opacity-50 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-opacity-30" style={{ borderColor: settings.colors.primary }}>
                <div className="flex items-center gap-2 mb-4">
                  <Clock className="w-5 h-5 text-purple-400" />
                  <h2 className="text-xl font-bold text-white">Your Recent Requests</h2>
                </div>
                <div className="space-y-3">
                  {recentRequests.map((request, idx) => (
                    <div key={idx} className="bg-gray-900 bg-opacity-50 rounded-lg p-3 border border-purple-500 border-opacity-20">
                      <div className="flex justify-between items-start gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="text-white font-medium text-sm mb-1 truncate">
                            {request.title}
                          </div>
                          <div className="text-gray-400 text-xs truncate">{request.artist}</div>
                        </div>
                        <div className="text-purple-400 text-xs whitespace-nowrap">
                          {request.requestedAt}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="text-center mt-8 text-purple-300 text-sm">
              <button
                onClick={() => setShowWelcome(true)}
                className="hover:text-white transition-colors underline mb-3"
              >
                View Instructions
              </button>
              
              <div className="mt-4 pt-4 border-t border-purple-500 border-opacity-30">
                <p className="text-purple-400 mb-2 font-semibold">DJ Controls:</p>
                <div className="flex gap-3 justify-center flex-wrap">
                  <a 
                    href="/admin-player.html" 
                    className="bg-purple-600 bg-opacity-30 hover:bg-opacity-50 text-white px-4 py-2 rounded-lg transition-all text-sm font-medium border border-purple-500 border-opacity-30"
                  >
                    üéõÔ∏è Admin Dashboard
                  </a>
                  <a 
                    href="/settings.html" 
                    className="bg-blue-600 bg-opacity-30 hover:bg-opacity-50 text-white px-4 py-2 rounded-lg transition-all text-sm font-medium border border-blue-500 border-opacity-30"
                  >
                    ‚öôÔ∏è Settings
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DJRequestInterface />);
  </script>
</body>
</html>